import requests

from app.models.user import User
from app.core.config import GRAFANA_API_KEY, GRAFANA_SERVER

headers = {'Authorization': f"Bearer {GRAFANA_API_KEY}", 'Content-Type': 'application/json'}

def create_dashboard(json: dict):
    return requests.post(f"{GRAFANA_SERVER}/api/dashboards/db", json=json, headers=headers)

def update_dashboard(json: dict):
    return requests.post(f"{GRAFANA_SERVER}/api/dashboards/db", json=json, headers=headers)

def delete_dashboard_by_uid(uid: str):
    return requests.delete(f"{GRAFANA_SERVER}/api/dashboards/uid/{uid}", headers=headers)

def generate_pod_dashboard_with_alert(user: User, pod_name: str):
    notifications_channel = namespace = str(user.id)

    return {
        'dashboard': {
            'description': 'This dashboard is auto-generated by KubeZephyr. PLEASE DO NOT MODIFY',
            'panels': [
                {
                    'collapsed': False,
                    'datasource': None,
                    'gridPos': {'h': 1, 'w': 24, 'x': 0, 'y': 0},
                    'id': 34,
                    'panels': [],
                    'repeat': None,
                    'title': 'Dashboard',
                    'type': 'row',
                },
                {
                    'datasource': 'Prometheus',
                    'fieldConfig': {
                        'defaults': {
                            'color': {'mode': 'thresholds'},
                            'mappings': [],
                            'thresholds': {
                                'mode': 'absolute',
                                'steps': [{'color': 'green', 'value': None}],
                            },
                        },
                        'overrides': [
                            {
                                'matcher': {'id': 'byName', 'options': 'Failed'},
                                'properties': [
                                    {
                                        'id': 'thresholds',
                                        'value': {
                                            'mode': 'absolute',
                                            'steps': [
                                                {'color': 'green', 'value': None},
                                                {'color': 'semi-dark-red', 'value': 1},
                                            ],
                                        },
                                    },
                                    {
                                        'id': 'mappings',
                                        'value': [
                                            {
                                                'from': '',
                                                'id': 1,
                                                'text': 'Failed',
                                                'to': '',
                                                'type': 1,
                                                'value': '1',
                                            }
                                        ],
                                    },
                                ],
                            },
                            {
                                'matcher': {'id': 'byName', 'options': 'Pending'},
                                'properties': [
                                    {
                                        'id': 'thresholds',
                                        'value': {
                                            'mode': 'absolute',
                                            'steps': [
                                                {'color': 'green', 'value': None},
                                                {'color': 'light-orange', 'value': 1},
                                            ],
                                        },
                                    },
                                    {
                                        'id': 'mappings',
                                        'value': [
                                            {
                                                'from': '',
                                                'id': 1,
                                                'text': 'Pending',
                                                'to': '',
                                                'type': 1,
                                                'value': '1',
                                            }
                                        ],
                                    },
                                ],
                            },
                            {
                                'matcher': {'id': 'byName', 'options': 'Running'},
                                'properties': [
                                    {
                                        'id': 'thresholds',
                                        'value': {
                                            'mode': 'absolute',
                                            'steps': [
                                                {'color': 'green', 'value': None},
                                                {'color': 'light-green', 'value': 1},
                                            ],
                                        },
                                    },
                                    {
                                        'id': 'mappings',
                                        'value': [
                                            {
                                                'from': '',
                                                'id': 1,
                                                'text': 'Running',
                                                'to': '',
                                                'type': 1,
                                                'value': '1',
                                            }
                                        ],
                                    },
                                ],
                            },
                            {
                                'matcher': {'id': 'byName', 'options': 'Succeeded'},
                                'properties': [
                                    {
                                        'id': 'thresholds',
                                        'value': {
                                            'mode': 'absolute',
                                            'steps': [
                                                {'color': 'green', 'value': None},
                                                {'color': 'light-blue', 'value': 1},
                                            ],
                                        },
                                    },
                                    {
                                        'id': 'mappings',
                                        'value': [
                                            {
                                                'from': '',
                                                'id': 1,
                                                'text': 'Succeeded',
                                                'to': '',
                                                'type': 1,
                                                'value': '1',
                                            }
                                        ],
                                    },
                                ],
                            },
                            {
                                'matcher': {'id': 'byName', 'options': 'Unknown'},
                                'properties': [
                                    {
                                        'id': 'thresholds',
                                        'value': {
                                            'mode': 'absolute',
                                            'steps': [
                                                {'color': 'green', 'value': None},
                                                {'color': 'rgb(87, 87, 87)', 'value': 1},
                                            ],
                                        },
                                    },
                                    {
                                        'id': 'mappings',
                                        'value': [
                                            {
                                                'from': '',
                                                'id': 1,
                                                'text': 'Unknown',
                                                'to': '',
                                                'type': 1,
                                                'value': '1',
                                            }
                                        ],
                                    },
                                ],
                            },
                        ],
                    },
                    'gridPos': {'h': 5, 'w': 5, 'x': 0, 'y': 1},
                    'id': 8,
                    'links': [],
                    'options': {
                        'colorMode': 'value',
                        'graphMode': 'none',
                        'justifyMode': 'center',
                        'orientation': 'auto',
                        'reduceOptions': {
                            'calcs': ['lastNotNull'],
                            'fields': '',
                            'values': False,
                        },
                        'text': {},
                        'textMode': 'auto',
                    },
                    'pluginVersion': '7.5.5',
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'sum(kube_pod_status_phase{{namespace=~"{namespace}",pod=~"{pod_name}"}} == 1) by(phase)',
                            'format': 'time_series',
                            'instant': True,
                            'interval': '',
                            'intervalFactor': 1,
                            'legendFormat': '{{ phase }}',
                            'refId': 'A',
                            'step': 2,
                        }
                    ],
                    'timeFrom': None,
                    'timeShift': None,
                    'title': 'Status',
                    'type': 'stat',
                },
                {
                    'alert': {
                        'alertRuleTags': {},
                        'conditions': [
                            {
                                'evaluator': {'params': [1], 'type': 'gt'},
                                'operator': {'type': 'and'},
                                'query': {'params': ['A', '1m', 'now']},
                                'reducer': {'params': [], 'type': 'sum'},
                                'type': 'query',
                            }
                        ],
                        'executionErrorState': 'alerting',
                        'for': '1m',
                        'frequency': '1m',
                        'handler': 1,
                        'message': f'錯誤：您的容器 {pod_name} 偵測到重新啟動，請確認設定是否皆為正確。',
                        'name': f'{user.realName}-{pod_name}: Container Restart alert',
                        'noDataState': 'ok',
                        'notifications': [{'uid': f'{notifications_channel}'}],
                    },
                    'aliasColors': {},
                    'bars': False,
                    'dashLength': 10,
                    'dashes': False,
                    'datasource': 'Prometheus',
                    'fieldConfig': {'defaults': {}, 'overrides': []},
                    'fill': 1,
                    'fillGradient': 0,
                    'gridPos': {'h': 5, 'w': 19, 'x': 5, 'y': 1},
                    'hiddenSeries': False,
                    'id': 12,
                    'legend': {
                        'avg': False,
                        'current': False,
                        'max': False,
                        'min': False,
                        'show': False,
                        'total': False,
                        'values': False,
                    },
                    'lines': True,
                    'linewidth': 1,
                    'links': [],
                    'nullPointMode': 'null',
                    'options': {'alertThreshold': True},
                    'percentage': False,
                    'pluginVersion': '7.5.5',
                    'pointradius': 2,
                    'points': False,
                    'renderer': 'flot',
                    'seriesOverrides': [],
                    'spaceLength': 10,
                    'stack': False,
                    'steppedLine': False,
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'kube_pod_container_status_restarts_total{{namespace=~"{namespace}", pod=~"{pod_name}"}}',
                            'format': 'time_series',
                            'hide': False,
                            'interval': '',
                            'intervalFactor': 2,
                            'legendFormat': '{{ container }}',
                            'refId': 'A',
                            'step': 2,
                        }
                    ],
                    'thresholds': [
                        {
                            'colorMode': 'critical',
                            'fill': True,
                            'line': True,
                            'op': 'gt',
                            'value': 1,
                            'visible': True,
                        }
                    ],
                    'timeFrom': None,
                    'timeRegions': [],
                    'timeShift': None,
                    'title': 'Container Restart',
                    'tooltip': {'shared': True, 'sort': 0, 'value_type': 'individual'},
                    'type': 'graph',
                    'xaxis': {
                        'buckets': None,
                        'mode': 'time',
                        'name': None,
                        'show': True,
                        'values': [],
                    },
                    'yaxes': [
                        {
                            '$$hashKey': 'object:79',
                            'decimals': 0,
                            'format': 'none',
                            'label': None,
                            'logBase': 1,
                            'max': None,
                            'min': '0',
                            'show': True,
                        },
                        {
                            '$$hashKey': 'object:80',
                            'format': 'short',
                            'label': None,
                            'logBase': 1,
                            'max': None,
                            'min': None,
                            'show': True,
                        },
                    ],
                    'yaxis': {'align': False, 'alignLevel': None},
                },
                {
                    'collapsed': False,
                    'datasource': None,
                    'gridPos': {'h': 1, 'w': 24, 'x': 0, 'y': 6},
                    'id': 35,
                    'panels': [],
                    'repeat': None,
                    'title': 'Resource',
                    'type': 'row',
                },
                {
                    'cacheTimeout': None,
                    'datasource': None,
                    'fieldConfig': {
                        'defaults': {
                            'color': {'mode': 'thresholds'},
                            'decimals': 2,
                            'mappings': [
                                {
                                    'id': 0,
                                    'op': '=',
                                    'text': 'N/A',
                                    'type': 1,
                                    'value': 'null',
                                }
                            ],
                            'thresholds': {
                                'mode': 'absolute',
                                'steps': [
                                    {'color': 'light-green', 'value': None},
                                    {'color': 'light-orange', 'value': 60},
                                    {'color': 'semi-dark-red', 'value': 80},
                                ],
                            },
                            'unit': 'percent',
                        },
                        'overrides': [],
                    },
                    'gridPos': {'h': 5, 'w': 5, 'x': 0, 'y': 7},
                    'id': 4,
                    'interval': None,
                    'links': [],
                    'maxDataPoints': 100,
                    'options': {
                        'colorMode': 'value',
                        'graphMode': 'area',
                        'justifyMode': 'auto',
                        'orientation': 'horizontal',
                        'reduceOptions': {
                            'calcs': ['lastNotNull'],
                            'fields': '',
                            'values': False,
                        },
                        'text': {},
                        'textMode': 'auto',
                    },
                    'pluginVersion': '7.5.5',
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'rate(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_rate{{namespace=~"{namespace}", container!="POD", pod=~"{pod_name}"}}[1m])',
                            'format': 'time_series',
                            'instant': False,
                            'interval': '',
                            'intervalFactor': 1,
                            'legendFormat': '',
                            'refId': 'A',
                            'step': 20,
                        }
                    ],
                    'title': 'CPU',
                    'type': 'stat',
                },
                {
                    'alert': {
                        'alertRuleTags': {},
                        'conditions': [
                            {
                                'evaluator': {'params': [90], 'type': 'gt'},
                                'operator': {'type': 'and'},
                                'query': {'params': ['A', '5m', 'now']},
                                'reducer': {'params': [], 'type': 'avg'},
                                'type': 'query',
                            }
                        ],
                        'executionErrorState': 'alerting',
                        'for': '5m',
                        'frequency': '1m',
                        'handler': 1,
                        'message': f'警告：您的容器 {pod_name} 的CPU使用率已經連續一分鐘超過90%。',
                        'name': f'{user.realName}-{pod_name}: CPU Usage alert',
                        'noDataState': 'ok',
                        'notifications': [{'uid': f'{notifications_channel}'}],
                    },
                    'aliasColors': {},
                    'bars': False,
                    'dashLength': 10,
                    'dashes': False,
                    'datasource': 'Prometheus',
                    'editable': True,
                    'error': False,
                    'fieldConfig': {'defaults': {'unit': 'percent'}, 'overrides': []},
                    'fill': 1,
                    'fillGradient': 0,
                    'grid': {},
                    'gridPos': {'h': 5, 'w': 9, 'x': 5, 'y': 7},
                    'hiddenSeries': False,
                    'id': 40,
                    'legend': {
                        'alignAsTable': True,
                        'avg': True,
                        'current': True,
                        'max': False,
                        'min': False,
                        'rightSide': True,
                        'show': False,
                        'total': False,
                        'values': True,
                    },
                    'lines': True,
                    'linewidth': 2,
                    'links': [],
                    'nullPointMode': 'connected',
                    'options': {'alertThreshold': True},
                    'paceLength': 10,
                    'percentage': False,
                    'pluginVersion': '7.5.5',
                    'pointradius': 5,
                    'points': False,
                    'renderer': 'flot',
                    'seriesOverrides': [],
                    'spaceLength': 10,
                    'stack': False,
                    'steppedLine': False,
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'rate(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_rate{{namespace=~"{namespace}", container!="POD", pod=~"{pod_name}"}}[1m])',
                            'format': 'time_series',
                            'instant': False,
                            'interval': '',
                            'intervalFactor': 1,
                            'legendFormat': 'Current',
                            'refId': 'A',
                            'step': 2,
                        }
                    ],
                    'thresholds': [
                        {
                            'colorMode': 'critical',
                            'fill': True,
                            'line': True,
                            'op': 'gt',
                            'value': 90,
                            'visible': True,
                        }
                    ],
                    'timeFrom': None,
                    'timeRegions': [],
                    'timeShift': None,
                    'title': 'CPU Usage',
                    'tooltip': {
                        'msResolution': True,
                        'shared': True,
                        'sort': 0,
                        'value_type': 'cumulative',
                    },
                    'type': 'graph',
                    'xaxis': {
                        'buckets': None,
                        'mode': 'time',
                        'name': None,
                        'show': True,
                        'values': [],
                    },
                    'yaxes': [
                        {
                            '$$hashKey': 'object:1172',
                            'format': 'percent',
                            'label': None,
                            'logBase': 1,
                            'max': '100',
                            'min': '0',
                            'show': True,
                        },
                        {
                            '$$hashKey': 'object:1173',
                            'format': 'short',
                            'label': None,
                            'logBase': 1,
                            'max': None,
                            'min': None,
                            'show': True,
                        },
                    ],
                    'yaxis': {'align': False, 'alignLevel': None},
                },
                {
                    'aliasColors': {},
                    'bars': False,
                    'dashLength': 10,
                    'dashes': False,
                    'datasource': 'Prometheus',
                    'editable': True,
                    'error': False,
                    'fieldConfig': {'defaults': {}, 'overrides': []},
                    'fill': 1,
                    'fillGradient': 0,
                    'grid': {},
                    'gridPos': {'h': 5, 'w': 10, 'x': 14, 'y': 7},
                    'hiddenSeries': False,
                    'id': 2,
                    'legend': {
                        'alignAsTable': True,
                        'avg': True,
                        'current': True,
                        'max': False,
                        'min': False,
                        'rightSide': True,
                        'show': False,
                        'total': False,
                        'values': True,
                    },
                    'lines': True,
                    'linewidth': 2,
                    'links': [],
                    'nullPointMode': 'connected',
                    'options': {'alertThreshold': True},
                    'paceLength': 10,
                    'percentage': False,
                    'pluginVersion': '7.5.5',
                    'pointradius': 5,
                    'points': False,
                    'renderer': 'flot',
                    'seriesOverrides': [],
                    'spaceLength': 10,
                    'stack': False,
                    'steppedLine': False,
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'sum by (container)(rate(container_cpu_usage_seconds_total{{namespace=~"{namespace}", pod=~"{pod_name}", container!="", container!="POD", image!=""}}[2m]))',
                            'format': 'time_series',
                            'instant': False,
                            'interval': '',
                            'intervalFactor': 1,
                            'legendFormat': 'Current',
                            'refId': 'A',
                            'step': 2,
                        },
                        {
                            'exemplar': True,
                            'expr': f'kube_pod_container_resource_limits_cpu_cores{{namespace=~"{namespace}", pod=~"{pod_name}", container!="POD"}}',
                            'format': 'time_series',
                            'interval': '',
                            'intervalFactor': 1,
                            'legendFormat': 'Limit',
                            'refId': 'C',
                            'step': 2,
                        },
                    ],
                    'thresholds': [],
                    'timeFrom': None,
                    'timeRegions': [],
                    'timeShift': None,
                    'title': 'CPU Usage',
                    'tooltip': {
                        'msResolution': True,
                        'shared': True,
                        'sort': 0,
                        'value_type': 'cumulative',
                    },
                    'type': 'graph',
                    'xaxis': {
                        'buckets': None,
                        'mode': 'time',
                        'name': None,
                        'show': True,
                        'values': [],
                    },
                    'yaxes': [
                        {
                            '$$hashKey': 'object:1092',
                            'format': 'short',
                            'label': None,
                            'logBase': 1,
                            'max': None,
                            'min': None,
                            'show': True,
                        },
                        {
                            '$$hashKey': 'object:1093',
                            'format': 'short',
                            'label': None,
                            'logBase': 1,
                            'max': None,
                            'min': None,
                            'show': True,
                        },
                    ],
                    'yaxis': {'align': False, 'alignLevel': None},
                },
                {
                    'cacheTimeout': None,
                    'datasource': 'Prometheus',
                    'fieldConfig': {
                        'defaults': {
                            'color': {'fixedColor': 'rgb(87, 87, 87)', 'mode': 'fixed'},
                            'mappings': [
                                {
                                    'id': 0,
                                    'op': '=',
                                    'text': 'N/A',
                                    'type': 1,
                                    'value': 'null',
                                }
                            ],
                            'thresholds': {
                                'mode': 'absolute',
                                'steps': [{'color': 'green', 'value': None}],
                            },
                            'unit': 'bytes',
                        },
                        'overrides': [],
                    },
                    'gridPos': {'h': 5, 'w': 5, 'x': 0, 'y': 12},
                    'id': 5,
                    'interval': None,
                    'links': [],
                    'maxDataPoints': 100,
                    'options': {
                        'colorMode': 'value',
                        'graphMode': 'area',
                        'justifyMode': 'auto',
                        'orientation': 'horizontal',
                        'reduceOptions': {
                            'calcs': ['lastNotNull'],
                            'fields': '',
                            'values': False,
                        },
                        'text': {},
                        'textMode': 'auto',
                    },
                    'pluginVersion': '7.5.5',
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'sum(container_memory_working_set_bytes{{namespace=~"{namespace}", pod=~"{pod_name}", container!="POD", container!=""}})',
                            'format': 'time_series',
                            'hide': False,
                            'interval': '',
                            'intervalFactor': 1,
                            'legendFormat': '',
                            'refId': 'A',
                            'step': 20,
                        }
                    ],
                    'title': 'Memory',
                    'type': 'stat',
                },
                {
                    'alert': {
                        'alertRuleTags': {},
                        'conditions': [
                            {
                                'evaluator': {'params': [90], 'type': 'gt'},
                                'operator': {'type': 'and'},
                                'query': {'params': ['A', '1m', 'now']},
                                'reducer': {'params': [], 'type': 'max'},
                                'type': 'query',
                            }
                        ],
                        'executionErrorState': 'alerting',
                        'for': '1m',
                        'frequency': '1m',
                        'handler': 1,
                        'message': f'警告：您的容器 {pod_name} 偵測到記憶體利用率超過90%。',
                        'name': f'{user.realName}-{pod_name}: Memory Usage alert',
                        'noDataState': 'ok',
                        'notifications': [{'uid': f'{notifications_channel}'}],
                    },
                    'aliasColors': {},
                    'bars': False,
                    'dashLength': 10,
                    'dashes': False,
                    'datasource': 'Prometheus',
                    'editable': False,
                    'error': False,
                    'fieldConfig': {'defaults': {}, 'overrides': []},
                    'fill': 1,
                    'fillGradient': 0,
                    'grid': {},
                    'gridPos': {'h': 5, 'w': 9, 'x': 5, 'y': 12},
                    'hiddenSeries': False,
                    'id': 41,
                    'legend': {
                        'alignAsTable': True,
                        'avg': False,
                        'current': False,
                        'max': False,
                        'min': False,
                        'rightSide': True,
                        'show': False,
                        'total': False,
                        'values': False,
                    },
                    'lines': True,
                    'linewidth': 2,
                    'links': [],
                    'nullPointMode': 'connected',
                    'options': {'alertThreshold': True},
                    'paceLength': 10,
                    'percentage': False,
                    'pluginVersion': '7.5.5',
                    'pointradius': 5,
                    'points': False,
                    'renderer': 'flot',
                    'seriesOverrides': [],
                    'spaceLength': 10,
                    'stack': False,
                    'steppedLine': False,
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'sum(container_memory_working_set_bytes{{namespace=~"{namespace}", pod=~"{pod_name}", container!="POD", container!="", image!=""}}) / sum(kube_pod_container_resource_limits_memory_bytes{{namespace=~"{namespace}", pod=~"{pod_name}"}}) * 100',
                            'format': 'time_series',
                            'interval': '10s',
                            'intervalFactor': 1,
                            'legendFormat': 'Current',
                            'metric': 'container_memory_usage_bytes',
                            'refId': 'A',
                            'step': 10,
                        }
                    ],
                    'thresholds': [
                        {
                            'colorMode': 'critical',
                            'fill': True,
                            'line': True,
                            'op': 'gt',
                            'value': 90,
                            'visible': True,
                        }
                    ],
                    'timeFrom': None,
                    'timeRegions': [],
                    'timeShift': None,
                    'title': 'Memory Usage',
                    'tooltip': {
                        'msResolution': True,
                        'shared': True,
                        'sort': 0,
                        'value_type': 'cumulative',
                    },
                    'type': 'graph',
                    'xaxis': {
                        'buckets': None,
                        'mode': 'time',
                        'name': None,
                        'show': True,
                        'values': [],
                    },
                    'yaxes': [
                        {
                            '$$hashKey': 'object:818',
                            'format': 'percent',
                            'label': None,
                            'logBase': 1,
                            'max': '100',
                            'min': '0',
                            'show': True,
                        },
                        {
                            '$$hashKey': 'object:819',
                            'format': 'short',
                            'label': None,
                            'logBase': 1,
                            'max': None,
                            'min': None,
                            'show': True,
                        },
                    ],
                    'yaxis': {'align': False, 'alignLevel': None},
                },
                {
                    'aliasColors': {},
                    'bars': False,
                    'dashLength': 10,
                    'dashes': False,
                    'datasource': 'Prometheus',
                    'editable': False,
                    'error': False,
                    'fieldConfig': {'defaults': {}, 'overrides': []},
                    'fill': 1,
                    'fillGradient': 0,
                    'grid': {},
                    'gridPos': {'h': 5, 'w': 10, 'x': 14, 'y': 12},
                    'hiddenSeries': False,
                    'id': 1,
                    'legend': {
                        'alignAsTable': True,
                        'avg': False,
                        'current': False,
                        'max': False,
                        'min': False,
                        'rightSide': True,
                        'show': False,
                        'total': False,
                        'values': False,
                    },
                    'lines': True,
                    'linewidth': 2,
                    'links': [],
                    'nullPointMode': 'connected',
                    'options': {'alertThreshold': True},
                    'paceLength': 10,
                    'percentage': False,
                    'pluginVersion': '7.5.5',
                    'pointradius': 5,
                    'points': False,
                    'renderer': 'flot',
                    'seriesOverrides': [],
                    'spaceLength': 10,
                    'stack': False,
                    'steppedLine': False,
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'container_memory_working_set_bytes{{namespace=~"{namespace}", pod=~"{pod_name}", container!="POD", container!="", image!=""}}',
                            'format': 'time_series',
                            'interval': '10s',
                            'intervalFactor': 1,
                            'legendFormat': 'Current',
                            'metric': 'container_memory_usage_bytes',
                            'refId': 'A',
                            'step': 10,
                        },
                        {
                            'exemplar': True,
                            'expr': f'kube_pod_container_resource_limits_memory_bytes{{namespace=~"{namespace}", pod=~"{pod_name}"}}',
                            'format': 'time_series',
                            'hide': False,
                            'interval': '10s',
                            'intervalFactor': 2,
                            'legendFormat': 'Limit',
                            'metric': 'kube_pod_container_resource_limits_memory_bytes',
                            'refId': 'C',
                            'step': 20,
                        },
                    ],
                    'thresholds': [],
                    'timeFrom': None,
                    'timeRegions': [],
                    'timeShift': None,
                    'title': 'Memory Usage',
                    'tooltip': {
                        'msResolution': True,
                        'shared': True,
                        'sort': 0,
                        'value_type': 'cumulative',
                    },
                    'type': 'graph',
                    'xaxis': {
                        'buckets': None,
                        'mode': 'time',
                        'name': None,
                        'show': True,
                        'values': [],
                    },
                    'yaxes': [
                        {
                            '$$hashKey': 'object:818',
                            'format': 'bytes',
                            'label': None,
                            'logBase': 1,
                            'max': None,
                            'min': None,
                            'show': True,
                        },
                        {
                            '$$hashKey': 'object:819',
                            'format': 'short',
                            'label': None,
                            'logBase': 1,
                            'max': None,
                            'min': None,
                            'show': True,
                        },
                    ],
                    'yaxis': {'align': False, 'alignLevel': None},
                },
                {
                    'cacheTimeout': None,
                    'datasource': 'Prometheus',
                    'fieldConfig': {
                        'defaults': {
                            'color': {'fixedColor': 'rgb(87, 87, 87)', 'mode': 'fixed'},
                            'decimals': 2,
                            'mappings': [
                                {
                                    'id': 0,
                                    'op': '=',
                                    'text': 'N/A',
                                    'type': 1,
                                    'value': 'null',
                                }
                            ],
                            'thresholds': {
                                'mode': 'absolute',
                                'steps': [{'color': 'green', 'value': None}],
                            },
                            'unit': 'Bps',
                        },
                        'overrides': [],
                    },
                    'gridPos': {'h': 5, 'w': 5, 'x': 0, 'y': 17},
                    'id': 7,
                    'interval': None,
                    'links': [],
                    'maxDataPoints': 100,
                    'options': {
                        'colorMode': 'value',
                        'graphMode': 'area',
                        'justifyMode': 'auto',
                        'orientation': 'horizontal',
                        'reduceOptions': {
                            'calcs': ['lastNotNull'],
                            'fields': '',
                            'values': False,
                        },
                        'text': {},
                        'textMode': 'auto',
                    },
                    'pluginVersion': '7.5.5',
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'sum(rate(container_network_transmit_bytes_total{{namespace=~"{namespace}",pod=~"{pod_name}"}}[5m])) + sum(rate(container_network_receive_bytes_total{{namespace=~"{namespace}",pod=~"{pod_name}"}}[5m])) ',
                            'format': 'time_series',
                            'interval': '',
                            'intervalFactor': 2,
                            'legendFormat': '',
                            'refId': 'A',
                            'step': 20,
                        }
                    ],
                    'title': 'Network RX/TX Total (bytes/sec)',
                    'type': 'stat',
                },
                {
                    'datasource': 'Prometheus',
                    'fieldConfig': {
                        'defaults': {
                            'color': {'mode': 'palette-classic'},
                            'custom': {
                                'axisLabel': '',
                                'axisPlacement': 'auto',
                                'barAlignment': 0,
                                'drawStyle': 'line',
                                'fillOpacity': 10,
                                'gradientMode': 'none',
                                'hideFrom': {
                                    'graph': False,
                                    'legend': False,
                                    'tooltip': False,
                                },
                                'lineInterpolation': 'linear',
                                'lineWidth': 2,
                                'pointSize': 5,
                                'scaleDistribution': {'type': 'linear'},
                                'showPoints': 'never',
                                'spanNulls': False,
                            },
                            'mappings': [],
                            'thresholds': {
                                'mode': 'absolute',
                                'steps': [
                                    {'color': 'green', 'value': None},
                                    {'color': 'red', 'value': 80},
                                ],
                            },
                            'unit': 'Bps',
                        },
                        'overrides': [],
                    },
                    'gridPos': {'h': 5, 'w': 19, 'x': 5, 'y': 17},
                    'id': 3,
                    'links': [],
                    'options': {
                        'graph': {},
                        'legend': {
                            'calcs': ['mean', 'lastNotNull', 'max', 'min', 'sum'],
                            'displayMode': 'hidden',
                            'placement': 'right',
                        },
                        'tooltipOptions': {'mode': 'single'},
                    },
                    'pluginVersion': '7.5.5',
                    'targets': [
                        {
                            'exemplar': True,
                            'expr': f'rate(container_network_transmit_bytes_total{{namespace=~"{namespace}", pod=~"{pod_name}",interface=~"eth0|ens.*"}}[5m])',
                            'format': 'time_series',
                            'interval': '',
                            'intervalFactor': 2,
                            'legendFormat': 'TX',
                            'refId': 'A',
                            'step': 2,
                        },
                        {
                            'exemplar': True,
                            'expr': f'rate(container_network_receive_bytes_total{{namespace=~"{namespace}", pod=~"{pod_name}",interface=~"eth0|ens.*"}}[5m])',
                            'format': 'time_series',
                            'interval': '',
                            'intervalFactor': 2,
                            'legendFormat': 'RX',
                            'refId': 'B',
                            'step': 2,
                        },
                    ],
                    'timeFrom': None,
                    'timeShift': None,
                    'title': 'POD Network',
                    'type': 'timeseries',
                },
                {
                    'collapsed': False,
                    'datasource': None,
                    'gridPos': {'h': 1, 'w': 24, 'x': 0, 'y': 22},
                    'id': 37,
                    'panels': [],
                    'title': 'Alerts',
                    'type': 'row',
                },
                {
                    'dashboardFilter': '',
                    'dashboardTags': [],
                    'datasource': None,
                    'fieldConfig': {'defaults': {}, 'overrides': []},
                    'folderId': None,
                    'gridPos': {'h': 6, 'w': 24, 'x': 0, 'y': 23},
                    'id': 39,
                    'limit': 10,
                    'nameFilter': '',
                    'onlyAlertsOnDashboard': True,
                    'pluginVersion': '7.5.5',
                    'repeat': None,
                    'show': 'current',
                    'sortOrder': 1,
                    'stateFilter': [
                        'ok',
                        'paused',
                        'no_data',
                        'execution_error',
                        'alerting',
                        'pending',
                    ],
                    'timeFrom': None,
                    'timeShift': None,
                    'title': 'Alerts',
                    'type': 'alertlist',
                },
            ],
            'refresh': '10s',
            'tags': ['kubernetes', 'pods', 'KubeZephyr'],
            'timezone': 'browser',
            'title': f'{user.realName}-{pod_name}: POD Overview with alerts',
            'uid': f'{namespace}-{pod_name}',
        },
        'folderId': 32
    }
